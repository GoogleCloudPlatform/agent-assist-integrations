<html>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Product+Sans"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/quasar@2.14.2/dist/quasar.prod.css"
      rel="stylesheet"
      type="text/css"
    />

    <script>
      window._uiModuleFlags = { debug: true };
    </script>

    <script src="javascripts/canvas-all.js"></script>
    <script src="javascripts/core.js"></script>
    <!-- WebComponents polyfill. Needed for rendering web components in older browsers. -->
    <script src="https://www.gstatic.com/external_hosted/document_register_element/document-register-element.js"></script>
    <script src="https://www.gstatic.com/agent-assist-ui-modules/container.js"></script>
    <!-- <script src="https://b2607f8b048001000002472f4c0a830e51538000000c1b800903000.proxy.googlers.com/container.js"></script> -->
    <script src="https://www.gstatic.com/agent-assist-ui-modules/transcript.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }

      body {
        background-color: #fff;
        font-family: 'Open Sans', sans-serif;
      }

      .header-bar > h2 {
        color: #5f6368;
        display: flex;
        align-items: center;
        font-family: 'Product Sans', Arial, sans-serif;
        font-size: 22px;
        font-weight: 300;
        line-height: 24px;
        margin-top: 16px;
        padding-left: 8px;
        position: relative;
        top: -1.5px;
        vertical-align: middle;
      }

      .header-bar > h2 > img {
        margin-top: 2px;
        margin-right: 8px;
      }

      .app-container {
        display: flex;
        flex: 1;
        gap: 60px;
        justify-content: space-between;
      }

      .messages-container {
        display: flex;
        flex-direction: column;
      }

      .messages-container,
      .ui-modules-container {
        flex: 1;
      }

      .ui-modules-container {
        padding-top: 24px;
      }

      .proxy-number {
        color: #222;
      }

      .header-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .conversations-container {
        align-items: center;
        display: flex;
        gap: 8px;
      }

      agent-assist-transcript {
        flex: 1;
      }

      #app {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="header-bar">
        <h2>
          <img
            src="https://www.gstatic.com/images/branding/googlelogo/svg/googlelogo_clr_74x24px.svg"
          />
          Contact Center AI
        </h2>
        <div class="conversations-container">
          <q-select
            v-model="conversationsModel"
            :options="conversationsOptions"
            label="Conversations"
          ></q-select>
        </div>
      </div>
      <div class="app-container">
        <div class="messages-container">
          <!-- The UI module that renders the conversation transcript. -->
          <agent-assist-transcript></agent-assist-transcript>
          <div class="conversation-input-boxes">
            <q-input
              outlined
              v-model="agentMessage"
              @keydown.enter.prevent="sendMessage('HUMAN_AGENT')"
              label="Agent"
            ></q-input>
            <br />
            <q-input
              outlined
              v-model="customerMessage"
              @keydown.enter.prevent="sendMessage('END_USER')"
              label="Customer"
            ></q-input>
          </div>
        </div>

        <div class="ui-modules-container">
          <agent-assist-ui-modules
            v-if="authToken"
            channel="chat"
            agent-desktop="Custom"
            v-bind:custom-api-endpoint="proxyServerEndpoint"
            v-bind:features="features"
            v-bind:conversation-profile="conversationProfile"
            v-bind:auth-token="authToken"
          ></agent-assist-ui-modules>
        </div>
      </div>
    </div>

    <!-- Note - test imports need to be here. -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.14.2/dist/quasar.umd.prod.js"></script>

    <!-- Utils -->
    <script>
      function getConversationId(name) {
        return name.split('/').slice(-1)[0];
      }
      function createConversationName() {
        const conversationId = `a${Math.floor(Math.random() * 10000000)}`;
        return `projects/agent-assist-console-demo/locations/global/conversations/${conversationId}`;
      }
    </script>

    <script>
      const salesforceContext = JSON.parse(
        '<%- JSON.stringify(salesforceContext) %>'
      );
      const { createApp, ref, watch } = Vue;

      const app = createApp({
        setup() {
          const proxyServerEndpoint = '<%= proxyServer %>';
          const conversationProfile = ref('<%= conversationProfile %>');
          const features = ref('<%= features %>');
          const activeConversationName = ref('');
          const conversationsOptions = ref(['Add new']);
          const conversationsModel = ref(null);
          const agentMessage = ref('');
          const customerMessage = ref('');
          const authToken = ref(null);

          // Fetch Dialogflow auth token.
          registerAuthToken(proxyServerEndpoint, '<%= salesforceToken %>').then(
            function (dialogflowToken) {
              authToken.value = dialogflowToken;

              // After an hour, refresh to avoid token expiration.
              // Note: Default token expiration is 2 hours, but can be changed by the
              // Salesforce Canvas application management settings
              setTimeout(() => {
                Sfdc.canvas.client.refreshSignedRequest(function (data) {
                  if (data.status === 200) {
                    const signedRequest = data.payload.response;
                    const part = signedRequest.split('.')[1];
                    const obj = JSON.parse(Sfdc.canvas.decode(part));
                    const salesforceToken = obj.client && obj.client.oauthToken;

                    if (!salesforceToken) {
                      console.error(
                        'No token present when refreshing signed request.'
                      );
                      return;
                    }

                    registerAuthToken(proxyServerEndpoint, salesforceToken)
                      .then(function (dialogflowToken) {
                        authToken.value = dialogflowToken;
                      })
                      .catch(function (err) {
                        console.error('Could not register OAuth token.', err);
                      });
                  } else {
                    console.error('Could not refresh OAuth token.');
                  }
                });
              }, 3600 * 1000);
            }
          );

          // Switch active conversation when the conversation select value changes.
          watch(conversationsModel, (newValue) => {
            if (newValue === 'Add new') {
              addConversation();
            } else {
              dispatchAgentAssistEvent('active-conversation-selected', {
                detail: {
                  conversationName: newValue,
                },
              });
              activeConversationName.value = newValue;
            }
          });

          function sendMessage(role) {
            const message =
              role === 'HUMAN_AGENT' ? agentMessage : customerMessage;

            dispatchAgentAssistEvent('analyze-content-requested', {
              detail: {
                conversationId: getConversationId(activeConversationName.value),
                participantRole: role,
                request: {
                  textInput: { text: message.value },
                  messageSendTime: new Date().toISOString(),
                },
              },
            });
            message.value = '';
          }

          function addConversation() {
            const conversationName = createConversationName();
            conversationsOptions.value.splice(
              conversationsOptions.value.length - 1,
              0,
              conversationName
            );
            conversationsModel.value = conversationName;
          }

          // Initialize the initial conversation.
          addAgentAssistEventListener('api-connector-initialized', () => {
            addConversation();
          });

          return {
            authToken,
            proxyServerEndpoint,
            conversationProfile,
            features,
            customerMessage,
            agentMessage,
            conversationsModel,
            conversationsOptions,
            addConversation,
            sendMessage,
          };
        },
      });

      app.use(Quasar);
      app.mount('#app');
    </script>
  </body>
</html>
